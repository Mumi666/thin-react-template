name: Build Docker Image Only

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ğŸ‘‰ è®¾ç½® Buildxï¼ˆå¯ç”¨ BuildKitï¼Œæ”¯æŒç¼“å­˜å’Œå¤šå¹³å°ï¼‰
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ğŸ‘‰ æ„å»ºé•œåƒï¼ˆä¸æ¨é€ï¼ï¼‰
      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          # å…³é”®ï¼šä¸æ¨é€
          push: false
          # å¯é€‰ï¼šæ‰“ä¸Šæœ¬åœ°æ ‡ç­¾ï¼ˆä»…ç”¨äºåç»­æ­¥éª¤è¯†åˆ«ï¼Œä¸ä¼šä¸Šä¼ ï¼‰
          tags: myapp:latest
          # å¯ç”¨ç¼“å­˜åŠ é€Ÿé‡å¤æ„å»ºï¼ˆä½¿ç”¨ GitHub Actions Cacheï¼‰
          cache-from: type=gha
          cache-to: type=gha,mode=max
          # å¯é€‰ï¼šå¯¼å‡ºé•œåƒä¸º tar æ–‡ä»¶ï¼ˆè§ä¸‹æ–¹æ‰©å±•ï¼‰
          # outputs: type=docker,dest=/tmp/image.tar
       # ğŸ‘‰ æ„å»ºå¹¶å¯¼å‡ºä¸º tar æ–‡ä»¶
      - name: Build and export image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: false
          tags: myapp:test
          outputs: type=docker,dest=/tmp/image.tar
# ğŸ‘‰ ä¸Šä¼ ä¸º workflow artifact
      - name: Upload image as artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: /tmp/image.tar
          retention-days: 1  # æµ‹è¯•ç”¨ï¼Œå¯ç¼©çŸ­ä¿ç•™æ—¶é—´
